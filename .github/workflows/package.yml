name: Debian XPack Build

on:
  push:
    branches:
      - main

env:
  XMAKE_ROOT: y
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    # container: debian:trixie-slim
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: true

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1


    - name: set XMAKE_GLOBALDIR
      run: echo "XMAKE_GLOBALDIR=${{ runner.workspace }}/xmake-global" >> $GITHUB_ENV

    - uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: v2.9.9
        actions-cache-folder: '.xmake-cache'

    - name: xmake repo --update
      run: xmake repo --update

    - name: cache packages from xrepo
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.XMAKE_GLOBALDIR }}/.xmake/packages
        key: ${{ runner.os }}-xrepo-${{ hashFiles('**/xmake.lua') }}

    - name: config
      run: xmake config -vD --policies=build.ccache -o tmp/build -m releasedbg --yes


    - name: Install Nix
      uses: nixbuild/nix-quick-install-action@v30

    - uses: nix-community/cache-nix-action@v6
      with:
        # restore and save a cache using this key
        primary-key: build-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
        # if there's no cache hit, restore a cache by this prefix
        restore-prefixes-first-match: build-${{ runner.os }}-
        # collect garbage until Nix store size (in bytes) is at most this number
        # before trying to save a new cache
        # 1G = 1073741824
        gc-max-store-size-linux: 1G
        # do purge caches
        purge: true
        # purge all versions of the cache
        purge-prefixes: build-${{ runner.os }}-
        # created more than this number of seconds ago
        # relative to the start of the `Post Restore and save Nix store` phase
        purge-created: 0
        # except any version with the key that is the same as the `primary-key`
        purge-primary-key: never


    - name: Build
      run: |
        xmake config --mode=release --plat=linux --arch=x86_64 --repl=true -y
        xmake build goldfish

        # 显示结果
        ls -la *.deb
        dpkg-deb -I *.deb

    - name: Package
      run: |
        xmake pack -f deb --repl=true -o ./

    - name: Create summary table
      run: |
        echo "## 生成的包文件" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| 类型 | 文件名 | 大小 | 版本 | 架构 |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|------|------|------|" >> $GITHUB_STEP_SUMMARY

        DIR="build/xpack/goldfish"

        # Debian 包
        for deb in "$DIR"/*.deb; do
            if [ -f "$deb" ]; then
                size=$(ls -lh "$deb" | awk '{print $5}')
                info=$(dpkg-deb -f "$deb" 2>/dev/null)
                pkg=$(echo "$info" | grep "^Package" | cut -d' ' -f2- || echo "")
                ver=$(echo "$info" | grep "^Version" | cut -d' ' -f2- || echo "")
                arch=$(echo "$info" | grep "^Architecture" | cut -d' ' -f2- || echo "")

                echo "| Debian | \`$(basename "$deb")\` | $size | $ver | $arch |" >> $GITHUB_STEP_SUMMARY
            fi
        done

        # RPM 包
        for rpm in "$DIR"/x86_64/*.rpm 2>/dev/null; do
            if [ -f "$rpm" ] && [[ "$rpm" != *.src.rpm ]]; then
                size=$(ls -lh "$rpm" | awk '{print $5}')
                if command -v rpm &>/dev/null; then
                    info=$(rpm -qip "$rpm" 2>/dev/null)
                    pkg=$(echo "$info" | grep "^Name" | cut -d' ' -f3 || echo "")
                    ver=$(echo "$info" | grep "^Version" | cut -d' ' -f3 || echo "")
                    arch=$(echo "$info" | grep "^Architecture" | cut -d' ' -f2 || echo "")
                else
                    pkg=""; ver=""; arch=""
                fi

                echo "| RPM | \`$(basename "$rpm")\` | $size | $ver | $arch |" >> $GITHUB_STEP_SUMMARY
            fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*目录: \`$DIR\`*" >> $GITHUB_STEP_SUMMARY

    - name: Upload all package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: goldfish-packages
        path: |
          build/xpack/goldfish/*.deb
          build/xpack/goldfish/*.src.rpm
          build/xpack/goldfish/**/*.rpm
        retention-days: 30
        if-no-files-found: error
