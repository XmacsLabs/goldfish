name: XPack Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install Dependencies
      run: |
        sudo add-apt-repository ppa:xmake-io/xmake
        sudo apt update
        sudo apt install -y git \
          curl 7zip unzip curl \
          gcc g++ \
          devscripts debhelper build-essential \
          xmake # xmake must be installed by apt (dpkg)

    - name: git add safe directory
      run: git config --global --add safe.directory '*'


    - name: set XMAKE_GLOBALDIR
      run: echo "XMAKE_GLOBALDIR=${{ runner.workspace }}/xmake-global" >> $GITHUB_ENV

    - name: xmake repo --update
      run: xmake repo --update

    - name: cache packages from xrepo
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.XMAKE_GLOBALDIR }}/.xmake/packages
        key: ${{ runner.os }}-xrepo-${{ hashFiles('**/xmake.lua') }}

    - name: Config and Build
      run: |
        sed -i 's|"deb", "rpm", "srpm"|"deb"|g' xmake.lua
        sed -i 's|set_default(false) -- repl-anchor|set_default(true)|g' xmake.lua

        xmake config -vyD --policies=build.ccache -o tmp/build -m releasedbg --repl=true
        xmake build goldfish

    - name: Package
      run: xmake pack -vyD goldfish

    - name: Create summary table
      run: |
        echo "## 生成的包文件" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| 类型 | 文件名 | 大小 | 版本 | 架构 |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|------|------|------|" >> $GITHUB_STEP_SUMMARY

        DIR="tmp/build/xpack/goldfish"

        # Debian 包
        for deb in "$DIR"/*.deb; do
            if [ -f "$deb" ]; then
                size=$(ls -lh "$deb" | awk '{print $5}')
                info=$(dpkg-deb -f "$deb" 2>/dev/null)
                pkg=$(echo "$info" | grep "^Package" | cut -d' ' -f2- || echo "")
                ver=$(echo "$info" | grep "^Version" | cut -d' ' -f2- || echo "")
                arch=$(echo "$info" | grep "^Architecture" | cut -d' ' -f2- || echo "")

                echo "| Debian | \`$(basename "$deb")\` | $size | $ver | $arch |" >> $GITHUB_STEP_SUMMARY
            fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*目录: \`$DIR\`*" >> $GITHUB_STEP_SUMMARY

    - name: Upload all package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: goldfish-packages
        path: tmp/build/xpack/goldfish/*.deb
        retention-days: 30
        if-no-files-found: error
