# Claude Code 工作规则

## Adhoc测试规则
在做adhoc测试时，不使用echo命令，也不使用 bin/goldfish -e，而是：
1. 将测试内容写入 /tmp 目录下的临时文件（文件名应该随机生成）
2. 使用 bin/goldfish /tmp/xyz.scm 的方式执行测试

## 代码格式规范
- 使用空格进行缩进，而不是制表符
- 建议缩进宽度为2个空格
- 使用 `bin/lint` 检测代码中的括号是否匹配

## 创建代码合并请求的方法
1. 使用 `git push -u origin 分支名` 推送代码
2. 在 git push 的输出中会显示创建 PR 的链接，例如：
   ```
   remote: Create a pull request for '分支名' on Gitee by visiting:
   remote: https://gitee.com/XmacsLabs/goldfish/pull/new/XmacsLabs:分支名...XmacsLabs:main
   ```
3. 点击或访问该链接即可创建合并请求

## 交流语言规范
- 默认使用中文与 Claude 进行交流
- 如用户输入其他语言（如英文），可临时使用该语言进行交流

## 其他规则
### 分支命名规范
- 分支名格式：`$USER/x_y/descr`
  - `$USER`：当前用户名
  - `x_y`：任务编号，如 `201_10`
  - `descr`：简短的任务描述，使用下划线连接
- 示例：`da/201_10/doc_update`

### 提交信息格式
- 使用单行格式：`[x_y] 简短描述`
  - `!编号`：在主干分支中，这是Gitee 自动生成的提交编号，如 `!870`，在合并过程中会保留
  - `[x_y]`：任务编号
  - `简短描述`：简洁的任务描述
- 示例：`[201_10] 更新文档格式和内容`

## 任务执行规则
1. **方案讨论优先**：对于任何非微小的代码改动，都必须先讨论实现方案和具体方法，经用户确认后再开始实施
2. **测试驱动开发**：采用测试驱动开发(TDD)方法，先撰写单元测试，与用户确认测试用例正确性，然后再开始实现功能
3. **任务拆分引导**：如果任务过于复杂或庞大，应该引导用户将任务拆分成更小、可管理的子任务
4. **渐进式实施**：优先采用小步快跑的方式，先实现核心功能，再逐步完善细节
5. **保持沟通**：在实施过程中，如有任何需要决策的点，都应该及时与用户沟通确认

## 代码提交规则
1. **提交信息格式**：代码提交信息使用单行即可，格式简洁明了
2. **详细信息位置**：更多详细信息放在 `devel/任务编号.md` 文件中，如 `devel/200_15.md`
3. **提交信息示例**：`git commit -m "将多行注释后置处理迁移到 pretty-print.scm"

## 开发文档撰写规范
### 概述
开发文档全部放在 `devel/` 目录下面。每一个任务以`devel/x_y.md`方式编号，一个任务可能会对应多个代码合并请求，以及主干分支的多次提交。

### 项目编号一览
| 项目编号  | 描述  | 备注 |
|---|---|---|
| 16 | 代码格式化 |
| 200 | 基础设施，包含CI/CD/xmake构建定义 |
| 201 | 文档和测试 |
| 202 | 性能优化 |
| 203 | (liii trie) |
| 204 | goldfish CLI/REPL |
| 205 | (liii coroutine) |
| 206 | (liii os) |
| 207 | (liii sort) |
| 208 | (liii unicode) | 

固定的任务编号:
1. `200_0`: 更新Goldfish Scheme的AUTHORS文件
2. `200_1`: 更新Goldfish Scheme的版本号

### devel/x_y.md 模板
```markdown
# [x_y] 任务描述

## 任务相关的代码文件
- 文件路径1
- 文件路径2

## 如何测试
一般先构建，再lint，最后运行测试用例。

## 日期 任务描述
### What
简要描述任务目标和完成的工作。

1. 第一项具体工作
2. 第二项具体工作
3. 第三项具体工作

### Why (可选)
说明为什么需要这个任务，解决什么问题。

### How (可选)
描述实现思路，特别是对于有难度的任务。

## 日期 之前的提交和任务描述
对于有多次提交的任务，将最新的提交描述放在上面，旧的放在下面。

之前的任务描述内容...
```

### 文档撰写方法

1. **标题格式**：
   - 使用 `# [x_y] 任务描述` 格式
   - x 表示主任务编号，y 表示子任务编号

2. **任务相关的代码文件**：
   - 列出所有相关的代码文件路径
   - 包括实现文件和测试文件

3. **如何测试**：
   - 提供完整的测试命令序列
   - 包括构建、代码检查和测试执行
   - 使用代码块格式

4. **任务描述**：
   - 使用 `## 日期 任务描述` 格式
   - **What (必需)**: 使用 `### What` 子标题和编号列表描述具体完成的工作
   - **Why (可选)**: 使用 `### Why` 说明任务背景和原因，如修复错误时可省略
   - **How (可选)**: 使用 `### How` 描述实现思路，特别是有难度的任务
   - 保持简洁明了，突出重点

5. **多次提交处理**：
   - 对于有多次提交的任务，将最新的提交描述放在文档顶部
   - 使用 `## 日期 之前的提交和任务描述` 部分记录之前的提交历史
   - 按时间倒序排列，最新的在上，旧的在下
   - 便于快速了解当前任务状态和进展

6. **内容要求**：
   - What 部分聚焦于 "做了什么" 和 "如何验证"
   - Why 部分说明任务背景、问题或需求
   - How 部分描述技术实现思路和难点
   - 避免过于详细的技术实现细节
   - 确保测试步骤可重现

### 示例参考
- [`devel/208_1.md`](devel/208_1.md) - unicode 模块实现
- [`devel/208_2.md`](devel/208_2.md) - u8-string-length 文档和测试
- [`devel/208_3.md`](devel/208_3.md) - u8-substring 文档和测试
- [`devel/208_4.md`](devel/208_4.md) - string->utf8 文档和测试

