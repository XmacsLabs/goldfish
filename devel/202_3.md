# [202_3] 优化 either 模块方法查找性能

## 任务相关的代码文件
- goldfish/liii/oop.scm - define-case-class 宏实现
- goldfish/liii/either.scm - either 模块实现
- bench/either.scm - 性能测试代码
- 3rdparty/s7/s7.c - S7 解释器核心

## 如何测试
一般先构建，再lint，最后运行测试用例。

```bash
# 构建
xmake

# 代码检查
bin/lint

# 运行性能测试
bin/goldfish bench/either.scm
```
## 2025-11-04 define-case-class2的instance-methods支持相互调用
## 2025-11-03 初步实现 define-case-class2，支持instance-methods，但不支持相互调用
## 2025-11-02 优化前
### 2025-11-02 either 模块基准测试结果
运行环境：100,000 次方法调用

| 操作 | 执行时间（秒） |
|------|---------------|
| either%get-or-else (right) | 0.36435580253601074 |
| either%get-or-else (left) | 0.3662841320037842 |
| either%or-else (left) | 1.4584710597991943 |
| either%or-else (right) | 1.3344879150390625 |
| either%left? (right) | 0.2757089138031006 |
| either%right? (left) | 0.311460018157959 |
| either%get (right) | 0.28499317169189453 |
| either%filter-or-else (right) | 0.3298149108886719 |
| either%filter-or-else (left) | 0.4249880313873291 |
| either%contains (right) | 1.3463361263275146 |
| either%contains (left) | 0.2979099750518799 |
| either%map (right) | 0.5904440879821777 |
| either%map (left) | 0.33159494400024414 |
| either%flat-map (right) | 0.5841150283813477 |
| either%flat-map (left) | 0.3303658962249756 |
| either%to-option (right) | 0.6768491268157959 |
| either%to-option (left) | 0.5557210445404053 |
| either%forall (right) | 0.301224946975708 |
| either%exists (right) | 0.3206610679626465 |

### 2025-11-02 define-case-class 基准测试结果

#### define-case-class-methods.scm 测试结果
```
=== Define-Case-Class Construction Performance Test ===

1 instance method:        0.10955810546875 seconds
2 instance methods:       0.11661720275878906 seconds
4 instance methods:       0.13527393341064453 seconds
8 instance methods:       0.14860296249389648 seconds
16 instance methods:      0.2049548625946045 seconds
32 instance methods:      0.3829507827758789 seconds

=== Method Call Performance Test ===

1 method call:            0.02328205108642578 seconds
2 methods - call method1: 0.02274298667907715 seconds
2 methods - call method2: 0.02349996566772461 seconds
4 methods - call method4: 0.02351689338684082 seconds
8 methods - call method8: 0.024670124053955078 seconds
16 methods - call method16: 0.04668092727661133 seconds
32 methods - call method32: 0.029199838638305664 seconds
```

#### define-case-class-fields.scm 测试结果
```
=== Define-Case-Class Fields Construction Performance Test ===

0 fields:                 0.09513592720031738 seconds
1 field:                  0.11644196510314941 seconds
2 fields:                 0.12001800537109375 seconds
4 fields:                 0.1294560432434082 seconds
8 fields:                 0.17789602279663086 seconds
16 fields:                0.23189687728881836 seconds
32 fields:                0.40476417541503906 seconds

=== Field Access Performance Test ===

1 field access:           0.019915103912353516 seconds
2 fields - access value1: 0.020737886428833008 seconds
2 fields - access value2: 0.02208995819091797 seconds
4 fields - access value4: 0.02362990379333496 seconds
8 fields - access value8: 0.025521039962768555 seconds
16 fields - access value16: 0.03955197334289551 seconds
32 fields - access value32: 0.05958104133605957 seconds
```

### 性能分析
- **either 模块最快操作**：`either%left?` 和 `either%get`（约 0.28 秒）
- **either 模块最慢操作**：`either%or-else` 和 `either%contains`（约 1.3-1.4 秒）
- **either 模块平均时间**：约 0.5 秒
- **define-case-class 构造时间**：随方法/字段数量线性增长，从 0.1 秒（1个方法）到 0.4 秒（32个方法）
- **方法调用时间**：相对稳定，约 0.02-0.06 秒
- **字段访问时间**：相对稳定，约 0.02-0.06 秒
- **性能瓶颈**：方法查找的 O(n) 复杂度


结论：闭包的创建最耗费时间。闭包的入参和闭包内部的define数量，都会影响闭包创建的性能。
