# [200_21] 从 s7.c 拆分出 s7_r7rs.h 和 s7_r7rs.c

## 任务相关的代码文件
- `src/s7.c`
- `src/s7.h`
- 新文件：`src/s7_r7rs.h`
- 新文件：`src/s7_r7rs.c`

## 如何测试
```
xmake config --yes -vD
xmake build
bin/goldfish tests/test_all.scm
```

## 2026/02/13 从 s7.c 拆分出 s7_r7rs.h 和 s7_r7rs.c，getenvs 迁入 s7_r7rs.c
### What
1. 从 `s7.c` 中提取 R7RS 相关代码到新文件 `s7_r7rs.c`
2. 创建 `s7_r7rs.h` 头文件，包含 R7RS 相关的函数声明和定义
3. 更新 `s7.c` 和 `s7.h`，移除 R7RS 相关代码，改为包含 `s7_r7rs.h`
4. 更新 `xmake.lua` 构建配置，将 `s7_r7rs.c` 添加到源文件列表

### Why
- 减少 `s7.c` 的文件大小，提高代码可维护性
- 分离关注点，使 R7RS 相关功能模块化
- 便于后续单独测试和优化 R7RS 功能
- 符合模块化设计原则
- **支持 vibe coding**：拆分后 `s7.c` 文件变小，更适合在编辑器中快速浏览和修改，提升开发体验

### How
1. **代码分析**：
   - 分析 `s7.c` 中所有 `#if WITH_R7RS` 条件编译块
   - 识别 R7RS 相关的变量声明、函数定义和 Scheme 代码
   - 主要发现：一个约 2681 行的 R7RS Scheme 代码块（第98738-101418行）

2. **头文件设计** (`s7_r7rs.h`)：
   - 包含 R7RS 相关的函数声明
   - 定义 R7RS 特定的宏和常量
   - 声明需要在 `s7.c` 和 `s7_r7rs.c` 之间共享的变量
   - 确保头文件保护机制，防止重复包含

3. **代码拆分**：
   - **创建 `s7_r7rs.c`**：
     - 将 `s7.c` 中第98738-101418行的 R7RS Scheme 代码块移动到新文件
     - 移动其他 R7RS 相关的函数实现
     - 包含必要的头文件：`s7.h` 和 `s7_r7rs.h`
   - **修改 `s7.c`**：
     - 移除 R7RS 相关代码块
     - 在适当位置添加 `#include "s7_r7rs.h"`
     - 更新函数调用和变量引用
   - **修改 `s7.h`**：
     - 移除 R7RS 相关的函数声明（移到 `s7_r7rs.h`）
     - 添加 `#include "s7_r7rs.h"`（如果需要）

4. **依赖关系**：
   ```
   s7.c → s7.h, s7_r7rs.h
   s7_r7rs.c → s7.h, s7_r7rs.h
   s7_r7rs.h → (无外部依赖，只包含声明)
   ```

5. **构建配置**：
   - 更新 `xmake.lua`，将 `s7_r7rs.c` 添加到 `goldfish` 目标的源文件列表
   - 确保 `s7_r7rs.c` 也使用 C11 标准（与 `s7.c` 一致）

6. **测试验证**：
   - 编译测试：确保没有编译错误
   - 链接测试：确保所有符号都能正确解析
   - 功能测试：运行 `test_all.scm` 确保 R7RS 功能正常
   - 回归测试：确保非 R7RS 功能不受影响