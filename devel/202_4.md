# 202_4: 在 (liii oop) 中新增 define-final-class
## 2025/11/04 define-final-class文档
## 2025/11/04 option的实现从 define-case-class 切换到 define-final-class
## 2025/11/04 define-final-class
### What
新增 define-final-class
+ 在构造器这块性能上比 define-case-class 好
+ 在方法访问上性能上比 define-case-class 差

## Option模块的性能测试结果对比

以下表格对比了 `define-case-class`（前）和 `define-final-class`（后）版本的 Option 模块性能差异。测试基于 100,000 次操作，时间单位为秒。

| 测试项目 | define-case-class (前) | define-final-class (后) | 性能提升 | 提升幅度 |
|---------|----------------------|-----------------------|---------|---------|
| **构造函数** | | | | |
| option 构造 | 0.2421 | 0.1465 | 0.0956 | 39.5% |
| none 构造 | 0.2248 | 0.1396 | 0.0852 | 37.9% |
| **访问方法（含构造）** | | | | |
| %get 方法（含构造） | 0.2530 | 0.1863 | 0.0667 | 26.4% |
| %get-or-else (有值，含构造) | 0.2736 | 0.1954 | 0.0782 | 28.6% |
| %get-or-else (无值，含构造) | 0.2734 | 0.1964 | 0.0770 | 28.2% |
| %defined? 方法（含构造） | 0.2582 | 0.2144 | 0.0438 | 17.0% |
| %empty? 方法（含构造） | 0.2656 | 0.1943 | 0.0713 | 26.8% |
| **访问方法（纯访问）** | | | | |
| %get 方法（纯访问） | 0.0239 | 0.0702 | -0.0463 | -193.7% |
| %get-or-else (有值，纯访问) | 0.0284 | 0.0748 | -0.0464 | -163.4% |
| %get-or-else (无值，纯访问) | 0.0308 | 0.0764 | -0.0456 | -148.1% |
| %defined? 方法（纯访问） | 0.0239 | 0.0740 | -0.0501 | -209.6% |
| %empty? 方法（纯访问） | 0.0235 | 0.0730 | -0.0495 | -210.6% |
| **转换方法** | | | | |
| %map 方法 | 0.3055 | 0.2352 | 0.0703 | 23.0% |
| %flat-map 方法 | 0.3000 | 0.2280 | 0.0720 | 24.0% |
| %filter (通过) | 0.3019 | 0.2358 | 0.0661 | 21.9% |
| %filter (不通过) | 0.3030 | 0.2327 | 0.0703 | 23.2% |
| **谓词方法** | | | | |
| %forall 方法 | 0.0349 | 0.0853 | -0.0504 | -144.4% |
| %exists 方法 | 0.0406 | 0.0873 | -0.0467 | -115.0% |
| %contains 方法 | 0.0343 | 0.0849 | -0.0506 | -147.5% |
| %for-each 方法 | 0.0408 | 0.0879 | -0.0471 | -115.4% |
| **比较方法** | | | | |
| %equals 方法 | 1.6711 | 0.6679 | 1.0032 | 60.0% |

## rich-list的性能评估
| 操作                       | 使用 `define-final-class` | 使用 `define-case-class` | 差值（秒）                   | 性能变化百分比 | 更快的实现                |
| ------------------------ | ----------------------- | ---------------------- | ----------------------- | ------- | -------------------- |
| `rich-list%empty%length` | 0.058030128479003906 秒  | 0.12981200218200684 秒  | 0.07178187370300293 秒   | +123.7% | `define-final-class` |
| `rich-list%map`          | 0.12200188636779785 秒   | 0.1729259490966797 秒   | 0.05092406272888185 秒   | +41.7%  | `define-final-class` |
| `rich-list%take`         | 0.09894680976867676 秒   | 0.15306591987609863 秒  | 0.05411911010742187 秒   | +54.7%  | `define-final-class` |
| `rich-list%slice`        | 0.12421488761901855 秒   | 0.18832921981811523 秒  | 0.06411433219909668 秒   | +51.6%  | `define-final-class` |
| `rich-list%exists`       | 0.1015160083770752 秒    | 0.11061310768127441 秒  | 0.00909709930419921 秒   | +9.0%   | `define-case-class`  |
| `rich-list%reverse`      | 0.06714797019958496 秒   | 0.1388568878173828 秒   | 0.07170891761779784 秒   | +106.8% | `define-final-class` |
| `rich-list%filter`       | 0.35752105712890625 秒   | 0.46900510787963867 秒  | 0.11148405075073242 秒   | +31.2%  | `define-final-class` |
| `rich-list%fold`         | 0.08075690269470215 秒   | 0.07579803466796875 秒  | -0.0049588680267334 秒   | -6.1%   | `define-case-class`  |
| `rich-list%length`       | 0.011996984481811523 秒  | 0.01043701171875 秒     | -0.001559972763061523 秒 | -13.0%  | `define-case-class`  |

## 性能分析总结

### 性能提升显著的项目
- **构造函数**：`define-final-class` 在对象构造方面有显著提升，约 38-40%
- **访问方法（含构造）**：包含对象构造的访问方法整体性能提升约 17-29%，其中 %get-or-else 方法提升约 28%，%get 方法提升约 26%
- **转换方法**：`%map`、`%flat-map`、`%filter` 等方法有约 22-24% 的性能提升
- **%equals 方法**：性能提升最为显著，达到 60.0%

### 性能下降的项目
- **访问方法（纯访问）**：不包含构造的纯方法访问性能下降明显，约 148-211%
- **谓词方法**：`%forall`、`%exists`、`%contains`、`%for-each` 等方法性能下降约 115-144%

### 总体评估
`define-final-class` 在复杂操作（如构造、转换、比较）方面表现更好，但在简单的访问和谓词方法上性能有所下降。这种性能模式表明 `define-final-class` 在对象生命周期管理方面更高效，但在方法调用开销上可能更高。

**关键发现**：
- 当考虑对象构造时，`define-final-class` 在访问方法上仍然有 17-29% 的性能提升
- 纯方法调用（不包含构造）的性能下降更加明显，说明 `define-final-class` 的方法调用开销更高
- 在实际使用场景中，通常需要构造对象后再进行方法调用，因此 `define-final-class` 的整体性能表现可能更好

