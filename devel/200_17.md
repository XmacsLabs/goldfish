# [200_17] 修复 S7 中的 Windows 编码问题

## 任务相关的代码文件
- `3rdparty/s7/s7.c`

## 如何测试

```scheme
(with-output-to-file "中文.txt" (lambda () (display "ok")))
```

在 Windows 上执行以上 goldfish 代码，应当正确创建名为 `中文.txt` 的文件。
在其他平台上也是如此，没有变化。

## 使用 `setlocale .UTF8` 来让 fopen 正确处理编码

### What

使用 `setlocale .UTF8` 来让 fopen 正确处理编码

### Why

修复 S7 中 fopen 的 Windows 编码问题。

### How

重定义 `fopen`，在新函数中调用 `setlocale(LC_ALL, ".UTF8")`

https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/setlocale-wsetlocale?view=msvc-170#utf-8-support

#### Why `setlocale`?

简洁性。此外，这种方法已经在 goldfish repl 中得到应用，因此不会带来任何额外的负担。

#### Why not tbox?

`port` 不是公共的 S7 类型（i.e. 没有构造函数）。S7 的实现涉及锁和状态控制。在 glue 层 (`goldfish.hpp`) 中使用 `tbox` 单独实现 `open-output-file` 函数会比目前的实现更加复杂。这种复杂性源于需要手动构造 `port`，并在需要时关闭和释放 tbox 文件和文件锁（需要确定何时执行这些操作）。

#### Why not `_wfopen`?

函数 `_wfopen` 需要包含头文件 `windows.h`，而该头文件会引入大量符号，因此需要进行的修改会非常广泛。这样做会使代码的复杂性高于目前的实现方式。

