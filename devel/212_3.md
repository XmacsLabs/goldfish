# [212_3] 实现 SRFI 113 Bags

## 如何测试
```bash
bin/goldfish tests/goldfish/liii/set-test.scm
```

## 2025/01/22 完成 SRFI 113 Bags 实现

### What
在 Goldfish Scheme 中完整实现了 SRFI 113 标准中的 Bags（多重集合）数据结构。Bags 与 Sets 类似，但允许元素重复。

实现的函数包括：

**构造器**
- `bag` - 创建包含指定元素的 bag
- `bag-unfold` - 从种子值展开生成 bag

**谓词**
- `bag?` - 判断是否为 bag
- `bag-contains?` - 判断 bag 是否包含元素
- `bag-empty?` - 判断 bag 是否为空
- `bag-disjoint?` - 判断两个 bag 是否不相交

**访问器**
- `bag-member` - 获取 bag 中与给定元素相等的元素
- `bag-element-comparator` - 获取 bag 的 comparator

**更新器**
- `bag-adjoin`, `bag-adjoin!` - 添加元素（允许重复）
- `bag-replace`, `bag-replace!` - 替换元素
- `bag-delete`, `bag-delete!` - 删除一个元素实例
- `bag-delete-all`, `bag-delete-all!` - 删除所有指定元素
- `bag-search!` - 搜索并可选更新/删除元素

**整体操作**
- `bag-size` - 返回元素总数（含重复）
- `bag-find` - 查找满足条件的元素
- `bag-count` - 计数满足条件的元素
- `bag-any?` - 是否存在满足条件的元素
- `bag-every?` - 是否所有元素都满足条件

**映射和折叠**
- `bag-map` - 映射 bag 中的元素
- `bag-for-each` - 对每个元素执行副作用操作
- `bag-fold` - 折叠 bag 中的所有元素
- `bag-filter`, `bag-filter!` - 过滤满足条件的元素
- `bag-remove`, `bag-remove!` - 移除满足条件的元素
- `bag-partition`, `bag-partition!` - 按条件分割 bag

**复制和转换**
- `bag-copy` - 复制 bag
- `bag->list` - 转换为列表（元素按计数重复）
- `list->bag` - 从列表创建 bag
- `list->bag!` - 将列表元素添加到已有 bag

**子集比较**
- `bag=?` - 判断 bag 相等
- `bag<?`, `bag>?` - 真子集/真超集比较
- `bag<=?`, `bag>=?` - 子集/超集比较

**集合论操作**
- `bag-union`, `bag-union!` - 并集（取最大计数）
- `bag-intersection`, `bag-intersection!` - 交集（取最小计数）
- `bag-difference`, `bag-difference!` - 差集
- `bag-xor`, `bag-xor!` - 对称差

**Bag 专有操作**
- `bag-sum`, `bag-sum!` - 和（计数相加）
- `bag-product`, `bag-product!` - 乘积（计数乘以倍数）
- `bag-unique-size` - 唯一元素数量
- `bag-element-count` - 获取元素的计数
- `bag-for-each-unique` - 对每个唯一元素及其计数执行操作
- `bag-fold-unique` - 折叠唯一元素及其计数
- `bag-increment!` - 增加元素计数
- `bag-decrement!` - 减少元素计数
- `bag->set` - 转换为 set（去重）
- `set->bag` - 从 set 创建 bag
- `set->bag!` - 将 set 元素添加到 bag
- `bag->alist` - 转换为关联列表 ((元素 . 计数) ...)
- `alist->bag` - 从关联列表创建 bag

**比较器**
- `bag-comparator` - bag 的 comparator

### Why
SRFI 113 是 Scheme 的集合和多重集合标准。之前已完成 Sets 部分，现在补充 Bags 部分以完整支持该 SRFI。

Bags（多重集合）与 Sets 的主要区别：
1. Bags 允许元素重复，而 Sets 不允许
2. `bag-adjoin` 总是增加元素计数，而 `set-adjoin` 对已有元素无操作
3. Bags 有专门的计数操作如 `bag-element-count`, `bag-unique-size`
4. 集合论操作的语义不同：
   - `bag-union` 取计数的最大值
   - `bag-intersection` 取计数的最小值
   - `bag-sum` 计数相加

### How

**内部表示**
Bag 使用标记列表表示：`('srfi-113-bag comparator . alist)`
其中 alist 是关联列表，每个元素为 `(element . count)` 对。

```scheme
(define %bag-tag 'srfi-113-bag)

(define (%make-bag comparator alist)
  (cons %bag-tag (cons comparator alist)))

(define (%bag-comparator b) (cadr b))
(define (%bag-alist b) (cddr b))
```

**核心辅助函数**
```scheme
;; 获取元素计数
(define (%bag-get-count element alist comparator)
  ...)

;; 设置元素计数（返回新 alist）
(define (%bag-set-count element count alist comparator)
  ...)

;; 增加/减少计数
(define (%bag-increment element n alist comparator) ...)
(define (%bag-decrement element n alist comparator) ...)
```

**架构设计**
遵循 `(liii vector)` 和 `(srfi srfi-133)` 的关系模式：
- 底层实现在 `(liii set)` 中
- 通过 `(srfi srfi-113)` 重新导出供 SRFI 兼容使用

**测试覆盖**
新增 106 个 Bag 相关测试用例，加上原有 123 个 Set 测试，共 229 个测试全部通过。

### Files Changed
- `goldfish/liii/set.scm` - 添加完整的 Bag 实现
- `goldfish/srfi/srfi-113.scm` - 导出 Bag 相关函数
- `tests/goldfish/liii/set-test.scm` - 添加 Bag 测试用例
