# 为 liii check 添加 stacktrace 调试支持 - 任务详情

--- 

## 任务概述

为 (liii check) 模块中的 check 函数增加 stacktrace 调试支持，当测试失败时提供更详细的调用栈信息，包括行号、文件位置和上下文，帮助开发者快速定位问题。

## 背景

当前的 check 模块在测试失败时只能显示"*** failed ***"，不提供详细的错误位置和上下文信息。为了提升调试体验，我们需要利用S7 Scheme内置的s7-stacktrace功能为失败的测试提供完整的调用栈追踪。

## 具体实施方案

### Phase 1: 分析现有check机制

1. 研究 liii/check.scm 的当前实现 (`check` `check-report` 等)
2. 理解s7-stacktrace的使用方式和输出格式
3. 确定集成点：check-failed时的调用链追踪

### Phase 2: 设计stacktrace集成

**核心思路**:
- 在测试失败时，捕获并使用s7-stacktrace获取详细位置信息
- 集成位置信息到现有的check-report输出中
- 尊重现有的输出模式 (off/summary/report-failed/report)

**技术要点**:
- 使用 `(s7-stacktrace)` 获取调用栈
- 利用 `(pair-line-number)` 和 `(pair-filename)` 提取位置信息
- 与现有的check模式控制机制兼容

### Phase 3: 实施方案

#### 方案A: 增强check-report (推荐)

修改 `check-report` 过程，在 `report-failed` 和 `report` 模式下自动包含stacktrace信息：

```scheme
;; 新增的增强版本check-report
(define (check-report-enhanced . msg)
  (if (not (null? msg))
      (begin (display (car msg))))
  (let ((stack-info (if (check-failed?) 
                      (s7-stacktrace) 
                      "")))
    (if (check-failed?)
        (begin
          (display "\n调用栈信息:")
          (display stack-info)))
    (srfi-78-check-report)))
```

#### 方案B: 新增check-stacktrace功能

保持现有check函数不变，新增专门的stacktrace调试工具：

```scheme
(define (check-with-stacktrace expr => expected)
  ;; wrapper函数，提供stacktrace支持
)
```

### Phase 4: 测试验证

#### 测试用例设计

```scheme
;; 测试失败的场景
(check (car '()) => 'x)  ; 应该显示空列表错误 + stacktrace
(check (car 123) => 'x)   ; 应该显示wrong-type-arg + stacktrace
(check (+ 1 1) => 3)     ; 应该显示值不匹配 + stacktrace
```

#### 验证标准

1. **输出标准**: 
   - 错误消息应包含文件名:行号格式
   - 调用栈应显示到测试case的完整路径
   - 不同输出模式应正确处理stacktrace

2. **兼容性验证**:
   - 与现有check代码无缝兼容
   - 不破坏现有测试脚本
   - 不影响性能测试用例

3. **用户体验**:
   - 输出格式清晰易读
   - 不需要额外配置即可工作
   - 可配置详细程度

## 技术实现细节

### 获取增强的位置信息

```scheme
;; 增强的信息收集函数
(define (get-test-location)
  (let ((call-stack (s7-stacktrace 5 40 60 40 #f)))
    (list
     (pair-filename test-expr) 
     (pair-line-number test-expr)
     call-stack)))
```

### 集成到check:proc

修改srfi-78.scm中的`check:proc`过程，在错误处理分支增加stacktrace获取：

```c
;; c代码中应当
(let ((test-loc (cons (pair-filename expr) (pair-line-number expr))))
  ;; 存储位置信息到错误记录中
)
```

## 提交计划

1. **第一阶段**: 实现基础stacktrace支持 (200_12.1)
2. **第二阶段**: 完善位置信息展示格式 (200_12.2)  
3. **第三阶段**: 性能优化和兼容性测试 (200_12.3)

## 预期影响

- **正向**: 显著减少调试时间，提升开发者体验
- **负向**: 极小性能开销（仅在测试失败时）
- **兼容**: 100%向后兼容，所有现有测试无需修改

## 边界考虑

- **资源使用**: 只在测试失败时调用s7-stacktrace，避免正常测试的性能损耗
- **配置控制**: 通过check-set-mode!配置来控制详细程度
- **安全性**: 不暴露内部实现细节，仅显示测试相关上下文化信息