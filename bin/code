#!/usr/bin/env elvish

use path
use str

# 取当前分支名
var current-branch = (git rev-parse --abbrev-ref HEAD)

if (not-eq $current-branch main) {
    echo (styled "Error: You are not on the main branch. Current branch: "$current-branch red)
    echo (styled "Please switch to main branch first: git checkout main" yellow)
    exit 1
}

echo "Already on main branch."

# 检查是否存在origin远程仓库
var has_origin = ?(git remote get-url origin > /dev/null 2>&1)

# 如果origin不存在，添加origin并拉取，然后移除origin
if (not $has_origin) {
    echo "Adding origin git@gitee.com:XmacsLabs/goldfish.git..."
    git remote add origin git@gitee.com:XmacsLabs/goldfish.git
    echo "Pulling latest code from main branch..."
    git pull origin main
    echo "Removing temporary origin...\n"
} else {
    # 如果origin存在，直接拉取
    echo "Pulling latest code from main branch..."
    git pull origin main
}

if (== (count $args) 0) {
    echo "Usage: bin/code branch_name"
    exit 1
}

# 提取分支名最后一部分，例如 da/201_6/string-any -> string-any
var branch_name = (path:base $args[0])
var timestamp = (date +%Y%m%d_%H%M%S_%N)
var workspace_dir = /tmp/goldfish/$branch_name/$timestamp

# 使用git worktree创建新的工作空间
echo "Creating workspace with git worktree: $workspace_dir"
git worktree add -b $branch_name $workspace_dir

# 切换到工作空间
cd $workspace_dir

# 检查ccr命令是否存在
if (not ?(which ccr)) {
    echo "Error: ccr command not found. Please install ccr."
    exit 1
}

# 启动ccr code
echo "Working on branch: $branch_name in workspace: $workspace_dir"
ccr code
